{% extends "base.html" %}

{% block title %}–ü—É—à–∏{% endblock %}

{% block content %}
<div class="card">
    <h2>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—É—à</h2>
    <form method="POST" action="/pushes/send">
        <label for="message">–°–æ–æ–±—â–µ–Ω–∏–µ:</label>
        <textarea id="message" name="message" required placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..."></textarea>
        
        <label>
            <input type="checkbox" id="send_to_all" name="send_to_all" value="true" checked onchange="toggleUserSelect()">
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
        </label>
        
        <div id="user_select" style="display: none; margin-top: 1rem;">
            <label for="target_user_ids">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
            <input type="text" id="target_user_ids" name="target_user_ids" placeholder="123456789, 987654321">
            <small style="color: #6b7280;">–ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ</small>
            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #d1d5db; padding: 0.5rem; margin-top: 0.5rem; border-radius: 4px;">
                {% for user in users %}
                <label style="display: block; padding: 0.25rem;">
                    <input type="checkbox" class="user-checkbox" value="{{ user.user_id }}" onchange="updateUserIds()">
                    {{ user.first_name }} (@{{ user.username }}) - {{ user.user_id }}
                </label>
                {% endfor %}
            </div>
        </div>
        
        <label for="scheduled_at" style="margin-top: 1rem;">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –≤—Ä–µ–º—è (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏):</label>
        <input type="datetime-local" id="scheduled_at" name="scheduled_at">
        <small style="color: #6b7280; display: block; margin-top: 0.25rem;">‚è∞ –í—Ä–µ–º—è —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ (UTC+3)</small>
        
        <button type="submit" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
</div>

<div class="card">
    <h2>–ò—Å—Ç–æ—Ä–∏—è –ø—É—à–µ–π</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>–°–æ–æ–±—â–µ–Ω–∏–µ</th>
                <th>–ü–æ–ª—É—á–∞—Ç–µ–ª–∏</th>
                <th>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</th>
                <th>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for push in pushes %}
            <tr>
                <td>{{ push.id }}</td>
                <td>{{ push.message[:50] }}{% if push.message|length > 50 %}...{% endif %}</td>
                <td>{% if push.send_to_all %}–í—Å–µ–º{% else %}–í—ã–±–æ—Ä–æ—á–Ω–æ{% endif %}</td>
                <td>{% if push.scheduled_at %}{{ push.scheduled_at }}{% else %}-{% endif %}</td>
                <td>{% if push.sent_at %}{{ push.sent_at }}{% else %}-{% endif %}</td>
                <td>
                    {% if push.status == 'sent' %}‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
                    {% elif push.status == 'sent_with_errors' %}‚ö†Ô∏è –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å –æ—à–∏–±–∫–∞–º–∏
                    {% elif push.status == 'failed' %}‚ùå –û—à–∏–±–∫–∞
                    {% elif push.status == 'processing' %}üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
                    {% else %}‚è≥ –û–∂–∏–¥–∞–µ—Ç{% endif %}
                </td>
                <td>
                    {% if push.total_targets %}
                        –í—Å–µ–≥–æ: {{ push.total_targets }}
                        {% if push.success_count is not none %} | ‚úÖ {{ push.success_count }}{% endif %}
                        {% if push.fail_count is not none and push.fail_count > 0 %} | ‚ùå {{ push.fail_count }}{% endif %}
                    {% else %}-{% endif %}
                </td>
                <td>
                    <form method="POST" action="/pushes/{{ push.id }}/delete" style="display: inline;">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—É—à?')" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
function toggleUserSelect() {
    const checkbox = document.getElementById('send_to_all');
    const userSelect = document.getElementById('user_select');
    userSelect.style.display = checkbox.checked ? 'none' : 'block';
}

function updateUserIds() {
    const checkboxes = document.querySelectorAll('.user-checkbox:checked');
    const userIds = Array.from(checkboxes).map(cb => cb.value).join(', ');
    document.getElementById('target_user_ids').value = userIds;
}
</script>
{% endblock %}
